{"ast":null,"code":"import _classCallCheck from \"@babel/runtime/helpers/esm/classCallCheck\";\nimport _createClass from \"@babel/runtime/helpers/esm/createClass\";\nimport _assertThisInitialized from \"@babel/runtime/helpers/esm/assertThisInitialized\";\nimport _inherits from \"@babel/runtime/helpers/esm/inherits\";\nimport _possibleConstructorReturn from \"@babel/runtime/helpers/esm/possibleConstructorReturn\";\nimport _getPrototypeOf from \"@babel/runtime/helpers/esm/getPrototypeOf\";\nimport _defineProperty from \"@babel/runtime/helpers/esm/defineProperty\";\nvar __jsx = React.createElement;\n\nfunction _createSuper(Derived) { return function () { var Super = _getPrototypeOf(Derived), result; if (_isNativeReflectConstruct()) { var NewTarget = _getPrototypeOf(this).constructor; result = Reflect.construct(Super, arguments, NewTarget); } else { result = Super.apply(this, arguments); } return _possibleConstructorReturn(this, result); }; }\n\nfunction _isNativeReflectConstruct() { if (typeof Reflect === \"undefined\" || !Reflect.construct) return false; if (Reflect.construct.sham) return false; if (typeof Proxy === \"function\") return true; try { Date.prototype.toString.call(Reflect.construct(Date, [], function () {})); return true; } catch (e) { return false; } }\n\nimport React, { Component } from \"react\";\nimport { withRouter } from \"next/router\";\nimport styles from \"../styles/player.module.css\";\nimport { connect } from \"react-redux\";\nimport * as actionTypes from \"../redux/action\";\nimport $axios from \"../$axios\";\nimport LoadingPage from \"./LoadingPage\";\nimport { AudioAnimation, AudioStop } from \"./AudioAnimation\";\n\nvar Player = /*#__PURE__*/function (_Component) {\n  _inherits(Player, _Component);\n\n  var _super = _createSuper(Player);\n\n  function Player(props) {\n    var _this;\n\n    _classCallCheck(this, Player);\n\n    _this = _super.call(this, props);\n\n    _defineProperty(_assertThisInitialized(_this), \"checkForPlayer\", function () {\n      if (window.Spotify) {\n        console.log(\"checkForPlayer\");\n        clearInterval(_this.playerCheckInterval);\n        _this.player = new window.Spotify.Player({\n          name: \"Soundify\",\n          getOAuthToken: function getOAuthToken(cb) {\n            cb(_this.state.token);\n          }\n        });\n      }\n\n      if (_this.player) {\n        _this.createEventHandlers();\n\n        _this.player.connect();\n      }\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"createEventHandlers\", function () {\n      _this.player.on(\"initialization_error\", function (e) {\n        console.error(\"Initialization error \", e);\n\n        _this.setState({\n          player_init_error: true\n        });\n      });\n\n      _this.player.on(\"authentication_error\", function (e) {\n        return console.error(\"Authentication error \", e);\n      });\n\n      _this.player.on(\"account_error\", function (e) {\n        return console.error(\"Account error \", e);\n      });\n\n      _this.player.on(\"playback_error\", function (e) {\n        return console.error(\"Playback error \", e);\n      });\n\n      _this.player.on(\"player_state_changed\", function (state) {\n        if (state) {\n          // console.log(\"player state changed\", state);\n          var duration = state.duration,\n              position = state.position; // duration = 100%\n          // position = ?%\n\n          var val = position * 100 / duration;\n\n          _this.setState({\n            playingInfo: state,\n            playing: !state.paused,\n            positionSliderValue: val\n          }); // Music started playing, start the position interval\n\n\n          if (!_this.props.isPlaying && !state.paused) {\n            _this.positionCheckInterval = setInterval(function () {\n              _this.checkChangePosition();\n            }, 1000);\n          } // Music stopped playing, clear the position interval\n\n\n          if (_this.props.isPlaying && state.paused) {\n            clearInterval(_this.positionCheckInterval);\n          }\n\n          if (_this.props.isPlaying === state.paused) {\n            _this.props.setIsPlaying(!state.paused);\n          }\n\n          if (!_this.props.currentlyPlaying || _this.props.currentlyPlaying !== state.track_window.current_track.name) {\n            var current_track = state.track_window.current_track;\n\n            _this.props.setCurrentlyPlaying(current_track.name);\n          }\n        }\n      });\n\n      _this.player.on(\"ready\", function (data) {\n        var device_id = data.device_id;\n        console.log(\"PLAYER CONNECTED \", device_id); // await this.setState({ deviceId: device_id });\n\n        _this.setState({\n          deviceId: device_id\n        }, function () {\n          _this.transferPlaybackHere();\n        });\n\n        var newUser = localStorage.getItem(\"newUser\"); // console.log(newUser, \"newUser\");\n\n        if (newUser) {\n          _this.setState({\n            user: JSON.parse(newUser)\n          });\n        }\n\n        _this.player.getVolume().then(function (vol) {\n          var volume = vol * 100;\n\n          _this.setState({\n            volumeSliderValue: volume\n          });\n        });\n      });\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"checkChangePosition\", function () {\n      _this.player.getCurrentState().then(function (state) {\n        if (state) {\n          var duration = state.duration,\n              position = state.position; // duration = 100%\n          // position = ?%\n\n          var val = position * 100 / duration;\n\n          if (val !== _this.state.positionSliderValue) {\n            _this.setState({\n              positionSliderValue: val\n            });\n          }\n\n          var positionStamp = _this.milisToMinutesAndSeconds(state.position);\n\n          var durationStamp = _this.milisToMinutesAndSeconds(state.duration);\n\n          _this.setState({\n            positionStamp: positionStamp,\n            durationStamp: durationStamp\n          });\n        }\n      });\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"transferPlaybackHere\", function () {\n      // ONLY FOR PREMIUM USERS - transfer the playback automatically to the web app.\n      // for normal users they have to go in the spotify app/website and change the device manually\n      // user type is stored in redux state => this.props.user.type\n      var deviceId = _this.state.deviceId;\n      fetch(\"https://api.spotify.com/v1/me/player\", {\n        method: \"PUT\",\n        headers: {\n          Authorization: \"Bearer \".concat(_this.state.token),\n          \"Content-Type\": \"application/json\"\n        },\n        body: JSON.stringify({\n          device_ids: [deviceId],\n          play: false\n        })\n      }).then(function (res) {\n        // console.log(\"status\", res);\n        if (res.status === 204) {\n          $axios.get(\"https://api.spotify.com/v1/me/player\").then(function () {\n            // Transferred playback successfully, get current timestamp\n            _this.checkChangePosition();\n          })[\"catch\"](function (err) {\n            console.log(err);\n          });\n        }\n      })[\"catch\"](function (e) {\n        return console.error(e);\n      }); // console.log('Hello', this.props);\n      // if (this.props.user.product === 'premium') {\n      // } else {\n      //   console.log(\n      //     'Cannot transfer playback automatically because you are not a premium user.'\n      //   );\n      // }\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"onPrevClick\", function () {\n      _this.player.previousTrack();\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"onPlayClick\", function () {\n      _this.player.togglePlay();\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"onNextClick\", function () {\n      _this.player.nextTrack();\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"milisToMinutesAndSeconds\", function (mil) {\n      var minutes = Math.floor(mil / 60000);\n      var seconds = (mil % 60000 / 1000).toFixed(0);\n      return minutes + \":\" + (seconds < 10 ? \"0\" : \"\") + seconds;\n    });\n\n    _this.state = {\n      deviceId: null,\n      playingInfo: null,\n      playing: false,\n      positionSliderValue: 50,\n      volumeSliderValue: 50,\n      positionStamp: \"00:00\",\n      durationStamp: \"00:00\",\n      player_init_error: false,\n      user: null,\n      noConnection: false\n    };\n    _this.player = null;\n    _this.playerCheckInterval = null;\n    _this.positionCheckInterval = null;\n    return _this;\n  }\n\n  _createClass(Player, [{\n    key: \"componentDidMount\",\n    value: function componentDidMount() {\n      var _this2 = this;\n\n      var count = 0;\n      var countInterval = setInterval(function () {\n        count++;\n\n        if (count > 15) {\n          _this2.setState({\n            noConnection: true\n          });\n\n          clearInterval(countInterval);\n        }\n      }, 1000);\n      this.setState({\n        token: localStorage.getItem(\"react-spotify-access-token\")\n      });\n      var newUser = localStorage.getItem(\"newUser\"); // console.log(newUser, \"newUser\");\n\n      if (newUser) {\n        this.setState({\n          user: JSON.parse(newUser)\n        });\n      } // console.log(Spotify, \"etata\");\n\n\n      window.onSpotifyWebPlaybackSDKReady = function () {\n        console.log(\"onready\");\n        window.Spotify = Spotify;\n      }; // console.log(window.Spotify, \"etata\");\n\n\n      this.playerCheckInterval = setInterval(function () {\n        return _this2.checkForPlayer();\n      }, 1000);\n    }\n  }, {\n    key: \"render\",\n    value: function render() {\n      // console.log(this.state.playingInfo, this.state.user, \"this.state.user\");\n      if (!(this.state.playingInfo && this.state.user) && this.state.noConnection) {\n        return __jsx(\"div\", {\n          className: styles.player\n        }, __jsx(\"div\", {\n          className: styles.loadingContainer\n        }, __jsx(\"div\", {\n          className: styles.loadingText\n        }, \"This takes longer than expected, first make sure your internet connection to spotify is fine, then go to spotify and select Soundify manually in your spotify connect devices and refresh the website\")));\n      }\n\n      if (!this.state.playingInfo || !this.state.user) {\n        return __jsx(\"div\", {\n          className: styles.player\n        }, __jsx(\"div\", {\n          className: styles.loadingContainer\n        }, __jsx(\"div\", {\n          style: {\n            position: \"relative\",\n            left: \"70px\",\n            bottom: \"130px\"\n          }\n        }, __jsx(LoadingPage, null)), __jsx(\"div\", {\n          className: styles.loadingText\n        }, \"Connecting to Spotify Player...\")));\n      } // console.log(this.state.playingInfo);\n\n\n      return __jsx(\"div\", {\n        className: styles.player\n      }, __jsx(\"div\", {\n        className: styles.playerHeader\n      }, __jsx(\"div\", null, __jsx(\"img\", {\n        className: styles.avatar,\n        src: this.state.user.avatar,\n        alt: \"\"\n      }), __jsx(\"span\", {\n        className: styles.nickname\n      }, this.state.user.displayName))), __jsx(\"div\", {\n        className: styles.playerCoverContainer\n      }, this.state.playing ? __jsx(\"img\", {\n        className: styles.playerCoverAnimation,\n        src: this.state.playingInfo.track_window.current_track.album.images[0].url,\n        alt: \"\"\n      }) : __jsx(\"img\", {\n        className: styles.playerCover,\n        src: this.state.playingInfo.track_window.current_track.album.images[0].url,\n        alt: \"\"\n      })), __jsx(\"div\", {\n        className: styles.musicInfo\n      }, __jsx(\"div\", {\n        className: styles.songName\n      }, this.state.playingInfo.track_window.current_track.name), __jsx(\"div\", {\n        className: styles.artistName\n      }, this.state.playingInfo.track_window.current_track.artists[0].name)), __jsx(\"div\", {\n        className: styles.playerPanel\n      }, __jsx(\"img\", {\n        src: \"/icons/prev.svg\",\n        alt: \"\",\n        onClick: this.onPrevClick\n      }), this.state.playing ? __jsx(\"img\", {\n        src: \"/icons/playing.svg\",\n        alt: \"\",\n        style: {\n          width: \"45px\"\n        },\n        onClick: this.onPlayClick\n      }) : __jsx(\"img\", {\n        src: \"/icons/play.svg\",\n        alt: \"\",\n        style: {\n          width: \"45px\"\n        },\n        onClick: this.onPlayClick\n      }), __jsx(\"img\", {\n        src: \"/icons/next.svg\",\n        alt: \"\",\n        onClick: this.onNextClick\n      })), __jsx(\"div\", {\n        className: styles.playerNext\n      }, this.state.playing ? __jsx(AudioAnimation, null) : __jsx(AudioStop, null)), __jsx(\"div\", {\n        className: styles.line\n      }));\n    }\n  }]);\n\n  return Player;\n}(Component);\n\nvar mapStateToProps = function mapStateToProps(state) {\n  return {\n    recently_played: state.recently_played,\n    user: state.current_user,\n    playNow: state.play_now,\n    currentlyPlaying: state.currently_playing,\n    isPlaying: state.isPlaying\n  };\n};\n\nvar mapDispatchToProps = function mapDispatchToProps(dispatch) {\n  return {\n    setUser: function setUser(user) {\n      return dispatch({\n        type: actionTypes.SET_USER,\n        user: user\n      });\n    },\n    fetchRecentlyPlayed: function fetchRecentlyPlayed(options) {\n      return dispatch(actionTypes.fetchRecentlyPlayed(options));\n    },\n    resetPlayNow: function resetPlayNow() {\n      return dispatch({\n        type: actionTypes.RESET_PLAY_NOW\n      });\n    },\n    setCurrentlyPlaying: function setCurrentlyPlaying(song) {\n      return dispatch({\n        type: actionTypes.SET_CURRENTLY_PLAYING,\n        song: song\n      });\n    },\n    setIsPlaying: function setIsPlaying(isPlaying) {\n      return dispatch({\n        type: actionTypes.SET_IS_PLAYING,\n        isPlaying: isPlaying\n      });\n    }\n  };\n};\n\nexport default connect(mapStateToProps, mapDispatchToProps)(withRouter(Player));","map":null,"metadata":{},"sourceType":"module"}