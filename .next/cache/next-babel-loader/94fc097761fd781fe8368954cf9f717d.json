{"ast":null,"code":"import _classCallCheck from \"@babel/runtime/helpers/esm/classCallCheck\";\nimport _createClass from \"@babel/runtime/helpers/esm/createClass\";\nimport _assertThisInitialized from \"@babel/runtime/helpers/esm/assertThisInitialized\";\nimport _inherits from \"@babel/runtime/helpers/esm/inherits\";\nimport _possibleConstructorReturn from \"@babel/runtime/helpers/esm/possibleConstructorReturn\";\nimport _getPrototypeOf from \"@babel/runtime/helpers/esm/getPrototypeOf\";\nimport _defineProperty from \"@babel/runtime/helpers/esm/defineProperty\";\nvar __jsx = React.createElement;\n\nfunction _createSuper(Derived) { return function () { var Super = _getPrototypeOf(Derived), result; if (_isNativeReflectConstruct()) { var NewTarget = _getPrototypeOf(this).constructor; result = Reflect.construct(Super, arguments, NewTarget); } else { result = Super.apply(this, arguments); } return _possibleConstructorReturn(this, result); }; }\n\nfunction _isNativeReflectConstruct() { if (typeof Reflect === \"undefined\" || !Reflect.construct) return false; if (Reflect.construct.sham) return false; if (typeof Proxy === \"function\") return true; try { Date.prototype.toString.call(Reflect.construct(Date, [], function () {})); return true; } catch (e) { return false; } }\n\nimport React, { Component } from \"react\";\nimport Router, { withRouter } from \"next/router\";\nimport * as actionTypes from \"../redux/action\";\nimport axios from \"axios\";\nimport { connect } from \"react-redux\";\nimport Login from \"../components/Login\";\n\nvar Index = /*#__PURE__*/function (_Component) {\n  _inherits(Index, _Component);\n\n  var _super = _createSuper(Index);\n\n  function Index(props) {\n    var _this;\n\n    _classCallCheck(this, Index);\n\n    _this = _super.call(this, props);\n\n    _defineProperty(_assertThisInitialized(_this), \"logInUserAndGetInfo\", function (newUser) {\n      console.log(\"LOG IN\", newUser); // console.log(this.props);\n\n      localStorage.setItem(\"newUser\", JSON.stringify(newUser));\n\n      _this.props.setUser(newUser); // set user in redux state\n\n\n      console.log(\"test\");\n      Router.push(\"/Home\");\n    });\n\n    _this.state = {\n      token: null\n    };\n    _this.token = null;\n    return _this;\n  }\n\n  _createClass(Index, [{\n    key: \"componentDidMount\",\n    value: function componentDidMount() {\n      var _this2 = this;\n\n      this.setState({\n        token: localStorage.getItem(\"react-spotify-access-token\")\n      }, function () {\n        // console.log(this.state.token, \"token\");\n        if (_this2.state.token !== undefined && _this2.state.token !== \"undefined\" && _this2.state.token) {\n          Router.push(\"/Home\");\n        }\n      }); // console.log(this.props, \"cdm\");\n\n      var params = this.getHashParams(); // If access token doesn't exist in has params, try to take it from local storage\n\n      if (params.access_token === \"undefined\") {\n        var currentAccessToken = localStorage.getItem(\"react-spotify-access-token\");\n\n        if (currentAccessToken) {\n          params.access_token = currentAccessToken;\n        }\n      } // console.log(\"Params after\", params);\n\n\n      if (params.access_token && params.access_token !== undefined && params.access_token !== \"undefined\") {\n        localStorage.setItem(\"react-spotify-access-token\", params.access_token);\n        axios.get(\"https://api.spotify.com/v1/me\", {\n          headers: {\n            Authorization: \"Bearer \".concat(params.access_token)\n          }\n        }).then(function (_ref) {\n          var data = _ref.data;\n          console.log(data, \"data\");\n\n          if (params.refresh_token) {\n            localStorage.setItem(\"react-spotify-refresh-token\", params.refresh_token);\n          }\n\n          var newUser = {\n            access_token: params.access_token,\n            displayName: data.display_name,\n            email: data.email,\n            type: data.type,\n            country: data.country,\n            product: data.product,\n            avatar: data.images[0].url\n          };\n          console.log(newUser, \"newUser\");\n\n          _this2.logInUserAndGetInfo(newUser);\n        })[\"catch\"](function (err) {\n          console.log(err, \"fgjxfjxf\"); // 401 = Unauthorized - the access token is incorrect (expired)\n\n          if (err || err.response.status === 401) {\n            // Check if refresh token exists\n            var refreshToken = localStorage.getItem(\"react-spotify-refresh-token\");\n\n            if (refreshToken) {\n              // Send refresh token to server to acquire a new access token\n              axios.post(\"http://localhost:3000/refresh\", {\n                data: JSON.stringify({\n                  refresh_token: refreshToken\n                })\n              }).then(function (res) {\n                console.log(\"Refresh token response -\", res.data);\n                axios.get(\"https://api.spotify.com/v1/me\", {\n                  headers: {\n                    Authorization: \"Bearer \".concat(res.data.access_token)\n                  }\n                }).then(function (_ref2) {\n                  var data = _ref2.data;\n                  localStorage.setItem(\"react-spotify-access-token\", res.data.access_token);\n                  var newUser = {\n                    access_token: params.access_token,\n                    displayName: data.display_name,\n                    email: data.email,\n                    type: data.type,\n                    country: data.country,\n                    product: data.product,\n                    avatar: data.images[0].url\n                  };\n\n                  _this2.logInUserAndGetInfo(newUser);\n                });\n              })[\"catch\"](function (e) {\n                console.log(\"Refresh token error -\", e);\n              })[\"finally\"](function () {\n                _this2.setState({\n                  loading: false\n                });\n              });\n            } else {\n              // Refresh token doesn't exist, the user is shown a 'login with Spotify button'\n              _this2.setState({\n                loading: false\n              });\n            }\n          }\n        });\n      } else {\n        // The user is shown a 'login with Spotify button'\n        this.setState({\n          loading: false\n        });\n      }\n    }\n  }, {\n    key: \"getHashParams\",\n    value: function getHashParams() {\n      var hashParams = {};\n      var e,\n          r = /([^&;=]+)=?([^&;]*)/g,\n          q = window.location.hash.substring(1);\n\n      while (e = r.exec(q)) {\n        hashParams[e[1]] = decodeURIComponent(e[2]);\n      }\n\n      console.log(hashParams, \"hashParams\");\n      return hashParams;\n    }\n  }, {\n    key: \"render\",\n    value: function render() {\n      // console.log(this.props, \"user\");\n      return __jsx(Login, null);\n    }\n  }]);\n\n  return Index;\n}(Component);\n\nvar mapStateToProps = function mapStateToProps(state) {\n  return {\n    user: state.current_user,\n    backgroundImage: state.backgroundImage\n  };\n};\n\nvar mapDispatchToProps = function mapDispatchToProps(dispatch) {\n  return {\n    setUser: function setUser(user) {\n      return dispatch({\n        type: actionTypes.SET_USER,\n        user: user\n      });\n    }\n  };\n};\n\nexport default connect(mapStateToProps, mapDispatchToProps)(withRouter(Index));","map":null,"metadata":{},"sourceType":"module"}